# Домашнее Задание №2

## ДЗ №2.1

### Условие

1. Написать приложение для Android (подойдет HelloWorld), либо использовать какое-то из ранее созданных

2. С помощью ADB
   - Включить логирование JIT-компиляции
   - Отключить JIT-компиляцию - посмотреть на скорость запуска и работы приложения
   - Принудительно скомпилировать приложение
      - полностью
      - на основе профиля

      Также посмотреть на скорость запуска и работы приложения, сделать выводы

3. Принудительно скомпилировать все приложения (осторожно)

### Отчёт

Скрипт для тестирования - нахождение среднего время запуска приложения

```bash
#!/bin/sh

if [ -z "$1" ]; then
  echo "Usage: $0 <package_name> [activity]"
  exit 1
fi

PACKAGE="$1"
ACTIVITY="${2:-.MainActivity}"

i=1
sum=0

while [ $i -le 10 ]; do
  am force-stop "$PACKAGE"
  time=$(am start -W "$PACKAGE/$ACTIVITY" | grep 'TotalTime' | cut -d ':' -f2 | tr -d ' ')
  echo "Run $i: $time ms"
  sum=$(expr $sum + $time)
  i=$(expr $i + 1)
done

avg=$(expr $sum / 10)
echo "Average: $avg ms"
```

Запуск для тестирования на примере Google Chrome
```bash
adb shell /data/local/tmp/start_avg.sh com.android.chrome com.google.android.apps.chrome.Main
```

Отключение JIT-компиляции

```bash
adb shell setprop dalvik.vm.usejit false
```

Полная (AOT) компиляция

```bash
adb shell cmd package compile -m speed -f com.android.chrome
```

Компиляция на основе профиля

```bash
adb shell cmd package compile -m speed-profile -f com.android.chrome
```

Сравнительная таблица результатов
| Режим компиляции                 | Время запуска (среднее) | Комментарии |
|----------------------------------|-------------------------|-------------|
| Без компиляции (чистый запуск)   | **857 мс**              | После сброса профиля и без JIT - самый медленный старт |
| Полная AOT (`speed`)             | **759 мс**              | Самый быстрый старт после принудительной компиляции |
| Профильная AOT (`speed-profile`) | **838 мс**              | Ближе к результату без компиляции - возможно, профиль не успел обновиться |

Оценить общую производительность приложения тяжело (особенно на HelloWorld), для этого надо использовать специальные инструменты (например стандартный профайлер), что сильно усложнит процесс.
Из результатов видно, что на современных телефонах разница между режимами компиляции почти неощутима для пользователя (50–100 мс).
Поэтому, на практике, режим `speed-profile` является лучшим балансом между скоростью, потреблением энергии и местом на устройстве.


## ДЗ №2.2

### Условие

1. Запустить приложение несколько раз (чем больше, тем лучше. Если в приложении есть разный функционал, то поэкспериментировать с переходами между экранами)

2. С помощью adb
   - Очистить данные профиля приложения
      - Запустить приложение и сравнить скорость запуска/работы

   - Очистить все скомпилированные данные приложения
      - Запустить приложение и сравнить скорость запуска/работы

3. Сделать выводы

### Отчёт

Очистить профиль

```bash
adb shell pm compile --reset com.android.chrome
```

Очистка всех скомпилированных данных

```bash
adb shell cmd package compile -m verify -f com.android.chrome
```

Так как JIT в данном случае включён, то многократный запуск приложения подряд для оценки среднего невозможен.
После удаления профиля или скомпилированного кода приложение вынуждено выполнять JIT-компиляцию в процессе работы или ждать накопления нового профиля, что делает запуск и первые моменты использования медленнее.
Но как было сказано ранее, оценивать производительность на глаз на современных телефонах из-за их мощности очень тяжело.


## ДЗ №2.3

### Условие

1. Написать приложение, которое по нажатию на кнопку вызывает System.gc()
   - Запустить приложение и посмотреть на его работу

2. С помощью ADB:
   - Попробовать изменить тип GC
   - Получить информацию о производительности GC

### Решение

Для того чтобы заставить GC сразу работать, необходимо:

```kotlin
System.runFinalization()
System.gc()
```

1. `runFinalization` - просит JVM выполнить методы finalize() у объектов, ожидающих финализации
2. `gc` — запрашивает у JVM выполнение сборки мусора

К сожалению, на двух разных телефонах (Android 11 и 13) не удалось сменить тип GC, никакой реакции на смену `dalvik.vm.gctype` нет.

Для получения информации о производительности GC можно воспользоваться профайлером или изучить логи.

```
I ransaero21.hw0: Explicit concurrent copying GC freed 808270(25MB) AllocSpace objects, 96(96MB) LOS objects, 83% free, 4790KB/28MB, paused 53us total 61.061ms
```

Метод получения информации о GC через `SIGQUIT` не сработал.